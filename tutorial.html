<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tutorial: A Simple Experiment in Python &mdash; DaCapo  documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="_static/graphviz.css?v=fd3f3429" />
      <link rel="stylesheet" type="text/css" href="_static/css/custom.css" />

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js?v=5d32c60e"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="_static/documentation_options.js?v=5929fcd5"></script>
        <script src="_static/doctools.js?v=9a2dae69"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Docker Configuration for JupyterHub-Dacapo" href="docker.html" />
    <link rel="prev" title="Installation" href="install.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            DaCapo
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">DaCapo API:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="install.html">Installation</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Tutorial: A Simple Experiment in Python</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#installation">Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#data-storage">Data Storage</a></li>
<li class="toctree-l2"><a class="reference internal" href="#configs">Configs</a></li>
<li class="toctree-l2"><a class="reference internal" href="#create-a-run">Create a Run</a></li>
<li class="toctree-l2"><a class="reference internal" href="#start-the-run">Start the Run</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="docker.html">Docker Configuration for JupyterHub-Dacapo</a></li>
<li class="toctree-l1"><a class="reference internal" href="aws.html">AWS EC2 Setup Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="autoapi/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="cli.html">CLI</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">DaCapo</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Tutorial: A Simple Experiment in Python</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/tutorial.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <nav class="contents local" id="contents" role="doc-toc">
<span id="module-dacapo"></span><span id="sec-tutorial-simple-experiment-python"></span><ul class="simple">
<li><p><a class="reference internal" href="#tutorial-a-simple-experiment-in-python" id="id2">Tutorial: A Simple Experiment in Python</a></p></li>
</ul>
</nav>
<section id="tutorial-a-simple-experiment-in-python">
<h1><a class="toc-backref" href="#id2" role="doc-backlink">Tutorial: A Simple Experiment in Python</a><a class="headerlink" href="#tutorial-a-simple-experiment-in-python" title="Link to this heading"></a></h1>
<p>This tutorial goes through all the necessary steps from installation
to getting an experiment running with dacapo. As an example we will learn
neuron segmentation on the <cite>cremi dataset &lt;https://cremi.org/data/&gt;</cite> using
a <em>3D U-Net</em>.</p>
<section id="installation">
<h2>Installation<a class="headerlink" href="#installation" title="Link to this heading"></a></h2>
<p>First, follow the <a class="reference internal" href="install.html#sec-install"><span class="std std-ref">installation guide</span></a>.</p>
</section>
<section id="data-storage">
<h2>Data Storage<a class="headerlink" href="#data-storage" title="Link to this heading"></a></h2>
<p>Next you much choose where you want to store your data. We have 2 supported
modes of saving data.</p>
<ol class="arabic">
<li><div class="line-block">
<div class="line">Save to disk: For particularly large data such as model weights or image</div>
<div class="line">volumes, it doesn’t make sense to store your data in the cloud. In These</div>
<div class="line">cases we store to disk.</div>
</div>
</li>
<li><div class="line-block">
<div class="line">Save to MongoDB: For dense data that can be nicely indexed, we encourage</div>
<div class="line">saving to a mongodb. This includes data such as loss and validation scores</div>
<div class="line">during training. This will allow us to quickly fetch specific scores for a</div>
<div class="line">range of experiments for comparison. Note: this option requires some set up,</div>
<div class="line">you need a mongodb accessible and you need to configure <cite>DaCapo</cite> to know</div>
<div class="line">where to find it. If you just want to get started quickly, you can save</div>
<div class="line">all data to disk.</div>
</div>
</li>
</ol>
<p><cite>DaCapo</cite> has a couple main data storage components:</p>
<ol class="arabic">
<li><div class="line-block">
<div class="line">Loss stats: We store the loss per iteration, and include a couple other</div>
<div class="line">statistics such as how long that iteration took to compute. These will</div>
<div class="line">be stored in the MongoDB if available.</div>
</div>
</li>
<li><div class="line-block">
<div class="line">Validation scores: For each <cite>:ref:Run&lt;sec_api_Run&gt;</cite> we will evaluate on every held out</div>
<div class="line">validation dataset every <cite>n</cite> iterations where <cite>n</cite> is defined as the</div>
<div class="line">validation interval on the <cite>:ref:RunConfig&lt;sec_api_RunConfig&gt;</cite>. These</div>
<div class="line">will be stored in the MongoDB if available.</div>
</div>
</li>
<li><div class="line-block">
<div class="line">Validation volumes: For qualitative inspection, we also store the results</div>
<div class="line">of validation in zarr datasets. This allows you to view the best predictions on</div>
<div class="line">your held out data according to the validation metric of your choice.</div>
<div class="line">This data will be stored on disk.</div>
</div>
</li>
<li><div class="line-block">
<div class="line">Checkpoints: These are copies of your model at various intervals during</div>
<div class="line">training. Storing checkpoints lets you retrieve the best performing model</div>
<div class="line">according to the validation metric of your choice.</div>
<div class="line">This data will be stored on disk.</div>
</div>
</li>
<li><div class="line-block">
<div class="line">Training Snapshots: Every <cite>n</cite> iterations where <cite>n</cite> corresponds to the</div>
<div class="line"><cite>snapshot_interval</cite> defined in the <cite>:ref:TrainerConfig&lt;sec_api_TrainerConfig&gt;</cite>,</div>
<div class="line">we store a snapshot that includes the inputs and outputs of the model at that</div>
<div class="line">iteration, and also some extra results that can be very helpful for debugging.</div>
<div class="line">Saved arrays include: Ground Truth, Target (Ground Truth transformed by Task),</div>
<div class="line">Raw, Prediction, Gradient, and Weights (for modifying the loss)</div>
<div class="line">This data will be stored on disk.</div>
</div>
</li>
<li><div class="line-block">
<div class="line">Configs: To make our runs easily reproducible, we save our configuration</div>
<div class="line">files and then use them to execute our experiments. This way other people</div>
<div class="line">can use the exact same configuration files or change single parameters and</div>
<div class="line">get comparable results. This data will be stored in the MongoDB if available.</div>
</div>
</li>
</ol>
<p>To define where this data goes, create a <cite>dacapo.yaml</cite> configuration file.
Here is a template:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">mongodbhost</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mongodb://dbuser:dbpass@dburl:dbport/</span>
<span class="nt">mongodbname</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dacapo</span>
<span class="nt">runs_base_dir</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/path/to/my/data/storage</span>
</pre></div>
</div>
<p>The <cite>runs_base_dir</cite> defines where your on-disk data will be stored.
The <cite>mongodbhost</cite> and <cite>mongodbname</cite> define the mongodb host and database
that will store your cloud data.
If you want to store everything on disk, replace <cite>mongodbhost</cite> and <cite>mongodbname</cite>
with a single <cite>type: files</cite> and everything will be saved to disk.</p>
</section>
<section id="configs">
<h2>Configs<a class="headerlink" href="#configs" title="Link to this heading"></a></h2>
<p>Next you need to create your configuration files for your experiments.
This can all be done in python. There is also a web based gui: the
<cite>dacapo-dashboard &lt;https://github.com/funkelab/dacapo-dashboard&gt;</cite>, see the
<span class="xref std std-ref">Simple Experiment using the Dashboard</span>
for a tutorial stepping through the use of the dashboard.</p>
<p>First lets handle some basics, importing, setting logging, etc.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">dacapo</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
</pre></div>
</div>
<p>Now lets create some configs.</p>
<ol class="arabic">
<li><p>DataSplit</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># TODO: create datasplit config</span>
<span class="n">datasplit_config</span> <span class="o">=</span> <span class="o">...</span>
</pre></div>
</div>
</li>
<li><p>Architecture</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">dacapo.experiments.architectures</span> <span class="kn">import</span> <span class="n">CNNectomeUNetConfig</span>
<span class="n">architecture_config</span> <span class="o">=</span> <span class="n">CNNectomeUNetConfig</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;small_unet&quot;</span><span class="p">,</span>
    <span class="n">input_shape</span><span class="o">=</span><span class="n">Coordinate</span><span class="p">(</span><span class="mi">212</span><span class="p">,</span> <span class="mi">212</span><span class="p">,</span> <span class="mi">212</span><span class="p">),</span>
    <span class="n">eval_shape_increase</span><span class="o">=</span><span class="n">Coordinate</span><span class="p">(</span><span class="mi">72</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">72</span><span class="p">),</span>
    <span class="n">fmaps_in</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">num_fmaps</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
    <span class="n">fmaps_out</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
    <span class="n">fmap_inc_factor</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
    <span class="n">downsample_factors</span><span class="o">=</span><span class="p">[(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)],</span>
    <span class="n">constant_upsample</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>Task</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">dacapo.experiments.tasks</span> <span class="kn">import</span> <span class="n">AffinitiesTaskConfig</span>

<span class="n">task_config</span> <span class="o">=</span> <span class="n">AffinitiesTaskConfig</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;AffinitiesPrediction&quot;</span><span class="p">,</span>
    <span class="n">neighborhood</span><span class="o">=</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)]</span>
<span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>Trainer</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">dacapo.experiments.trainers</span> <span class="kn">import</span> <span class="n">GunpowderTrainerConfig</span>
<span class="kn">from</span> <span class="nn">dacapo.experiments.trainers.gp_augments</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">SimpleAugmentConfig</span><span class="p">,</span>
    <span class="n">ElasticAugmentConfig</span><span class="p">,</span>
    <span class="n">IntensityAugmentConfig</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">trainer_config</span> <span class="o">=</span> <span class="n">GunpowderTrainerConfig</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;gunpowder&quot;</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">,</span>
    <span class="n">augments</span><span class="o">=</span><span class="p">[</span>
        <span class="n">SimpleAugmentConfig</span><span class="p">(),</span>
        <span class="n">ElasticAugmentConfig</span><span class="p">(</span>
            <span class="n">control_point_spacing</span><span class="o">=</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span>
            <span class="n">control_point_displacement_sigma</span><span class="o">=</span><span class="p">(</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">),</span>
            <span class="n">rotation_interval</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">),</span>
            <span class="n">subsample</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
            <span class="n">uniform_3d_rotation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">IntensityAugmentConfig</span><span class="p">(</span>
            <span class="n">scale</span><span class="o">=</span><span class="p">(</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">1.75</span><span class="p">),</span>
            <span class="n">shift</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.35</span><span class="p">),</span>
            <span class="n">clip</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">],</span>
    <span class="n">num_data_fetchers</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="n">snapshot_interval</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
    <span class="n">min_masked</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span>
    <span class="n">min_labelled</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</li>
</ol>
</section>
<section id="create-a-run">
<h2>Create a Run<a class="headerlink" href="#create-a-run" title="Link to this heading"></a></h2>
<p>Now that we have our components configured, we just need to
combine them into a run and start training.</p>
<div class="literal-block-wrapper docutils container" id="id1">
<div class="code-block-caption"><span class="caption-text">Create a run</span><a class="headerlink" href="#id1" title="Link to this code"></a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>  <span class="kn">from</span> <span class="nn">funlib.geometry</span> <span class="kn">import</span> <span class="n">Coordinate</span>
  <span class="kn">from</span> <span class="nn">dacapo.experiments.run_config</span> <span class="kn">import</span> <span class="n">RunConfig</span>
  <span class="kn">from</span> <span class="nn">dacapo.experiments.run</span> <span class="kn">import</span> <span class="n">Run</span>

  <span class="kn">from</span> <span class="nn">torchsummary</span> <span class="kn">import</span> <span class="n">summary</span>


  <span class="n">run_config</span> <span class="o">=</span> <span class="n">RunConfig</span><span class="p">(</span>
      <span class="n">name</span><span class="o">=</span><span class="s2">&quot;tutorial_run&quot;</span><span class="p">,</span>
      <span class="n">task_config</span><span class="o">=</span><span class="n">task_config</span><span class="p">,</span>
      <span class="n">architecture_config</span><span class="o">=</span><span class="n">architecture_config</span><span class="p">,</span>
      <span class="n">trainer_config</span><span class="o">=</span><span class="n">trainer_config</span><span class="p">,</span>
      <span class="n">datasplit_config</span><span class="o">=</span><span class="n">datasplit_config</span><span class="p">,</span>
      <span class="n">repetition</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
      <span class="n">num_iterations</span><span class="o">=</span><span class="mi">100000</span><span class="p">,</span>
      <span class="n">validation_interval</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
  <span class="p">)</span>

  <span class="n">run</span> <span class="o">=</span> <span class="n">Run</span><span class="p">(</span><span class="n">run_config</span><span class="p">)</span>

  <span class="c1"># if you want a summary of the model you can print that here</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">summary</span><span class="p">(</span><span class="n">run</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">212</span><span class="p">,</span> <span class="mi">212</span><span class="p">,</span> <span class="mi">212</span><span class="p">)))</span>
</pre></div>
</div>
</div>
</section>
<section id="start-the-run">
<h2>Start the Run<a class="headerlink" href="#start-the-run" title="Link to this heading"></a></h2>
<p>You have 2 options for starting the run:</p>
<ol class="arabic">
<li><p>Simple case:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">dacapo.train</span> <span class="kn">import</span> <span class="n">train_run</span>

<span class="n">train_run</span><span class="p">(</span><span class="n">run</span><span class="p">)</span>
</pre></div>
</div>
<p>Your job will run but you haven’t stored your configuration files, so
it may be difficult to reproduce your work without copy pasting everything
you’ve written so far.</p>
</li>
<li><p>Store your configs</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">dacapo.store.create_store</span> <span class="kn">import</span> <span class="n">create_config_store</span>
<span class="kn">from</span> <span class="nn">dacapo.train</span> <span class="kn">import</span> <span class="n">train</span>

<span class="n">config_store</span> <span class="o">=</span> <span class="n">create_config_store</span><span class="p">()</span>

<span class="n">config_store</span><span class="o">.</span><span class="n">store_datasplit_config</span><span class="p">(</span><span class="n">datasplit_config</span><span class="p">)</span>
<span class="n">config_store</span><span class="o">.</span><span class="n">store_architecture_config</span><span class="p">(</span><span class="n">architecture_config</span><span class="p">)</span>
<span class="n">config_store</span><span class="o">.</span><span class="n">store_task_config</span><span class="p">(</span><span class="n">task_config</span><span class="p">)</span>
<span class="n">config_store</span><span class="o">.</span><span class="n">store_trainer_config</span><span class="p">(</span><span class="n">trainer_config</span><span class="p">)</span>
<span class="n">config_store</span><span class="o">.</span><span class="n">store_run_config</span><span class="p">(</span><span class="n">run_config</span><span class="p">)</span>

<span class="c1"># Optional start training by config name:</span>
<span class="n">train</span><span class="p">(</span><span class="n">run_config</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</pre></div>
</div>
<p>Once you have stored all your configs, you can start your Run just with
the name of the config you want to start. If you want to start your
run on some compute cluster, you might want to use the command line
interface: <code class="code docutils literal notranslate"><span class="pre">dacapo</span> <span class="pre">train</span> <span class="pre">-r</span> <span class="pre">{run_config.name}</span></code>.
This makes it particularly convenient to run on compute nodes where
you can specify specific compute requirements.</p>
</li>
</ol>
<p>Finally your job should be running. The full script to run this tutorial is
provided here:</p>
<p><cite>dacapo.yaml</cite>:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">mongodbhost</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mongodb://dbuser:dbpass@dburl:dbport/</span>
<span class="nt">mongodbname</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dacapo</span>
<span class="nt">runs_base_dir</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/path/to/my/data/storage</span>
</pre></div>
</div>
<p><cite>train.py</cite>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">dacapo</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">dacapo.experiments.architectures</span> <span class="kn">import</span> <span class="n">CNNectomeUNetConfig</span>
<span class="kn">from</span> <span class="nn">dacapo.experiments.tasks</span> <span class="kn">import</span> <span class="n">AffinitiesTaskConfig</span>
<span class="kn">from</span> <span class="nn">dacapo.experiments.trainers</span> <span class="kn">import</span> <span class="n">GunpowderTrainerConfig</span>
<span class="kn">from</span> <span class="nn">dacapo.experiments.trainers.gp_augments</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">SimpleAugmentConfig</span><span class="p">,</span>
    <span class="n">ElasticAugmentConfig</span><span class="p">,</span>
    <span class="n">IntensityAugmentConfig</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">funlib.geometry</span> <span class="kn">import</span> <span class="n">Coordinate</span>
<span class="kn">from</span> <span class="nn">dacapo.experiments.run_config</span> <span class="kn">import</span> <span class="n">RunConfig</span>
<span class="kn">from</span> <span class="nn">dacapo.experiments.run</span> <span class="kn">import</span> <span class="n">Run</span>
<span class="kn">from</span> <span class="nn">dacapo.store.create_store</span> <span class="kn">import</span> <span class="n">create_config_store</span>
<span class="kn">from</span> <span class="nn">dacapo.train</span> <span class="kn">import</span> <span class="n">train</span>

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

<span class="c1"># TODO: create datasplit config</span>
<span class="n">train_array</span>
<span class="n">datasplit_config</span> <span class="o">=</span> <span class="o">...</span>


<span class="c1"># Create Architecture Config</span>
<span class="n">architecture_config</span> <span class="o">=</span> <span class="n">CNNectomeUNetConfig</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;small_unet&quot;</span><span class="p">,</span>
    <span class="n">input_shape</span><span class="o">=</span><span class="n">Coordinate</span><span class="p">(</span><span class="mi">212</span><span class="p">,</span> <span class="mi">212</span><span class="p">,</span> <span class="mi">212</span><span class="p">),</span>
    <span class="n">eval_shape_increase</span><span class="o">=</span><span class="n">Coordinate</span><span class="p">(</span><span class="mi">72</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">72</span><span class="p">),</span>
    <span class="n">fmaps_in</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">num_fmaps</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
    <span class="n">fmaps_out</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
    <span class="n">fmap_inc_factor</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
    <span class="n">downsample_factors</span><span class="o">=</span><span class="p">[(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)],</span>
    <span class="n">constant_upsample</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Create Task Config</span>

<span class="n">task_config</span> <span class="o">=</span> <span class="n">AffinitiesTaskConfig</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;AffinitiesPrediction&quot;</span><span class="p">,</span>
    <span class="n">neighborhood</span><span class="o">=</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)]</span>
<span class="p">)</span>


<span class="c1"># Create Trainer Config</span>

<span class="n">trainer_config</span> <span class="o">=</span> <span class="n">GunpowderTrainerConfig</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;gunpowder&quot;</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">,</span>
    <span class="n">augments</span><span class="o">=</span><span class="p">[</span>
        <span class="n">SimpleAugmentConfig</span><span class="p">(),</span>
        <span class="n">ElasticAugmentConfig</span><span class="p">(</span>
            <span class="n">control_point_spacing</span><span class="o">=</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span>
            <span class="n">control_point_displacement_sigma</span><span class="o">=</span><span class="p">(</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">),</span>
            <span class="n">rotation_interval</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">),</span>
            <span class="n">subsample</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
            <span class="n">uniform_3d_rotation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">IntensityAugmentConfig</span><span class="p">(</span>
            <span class="n">scale</span><span class="o">=</span><span class="p">(</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">1.75</span><span class="p">),</span>
            <span class="n">shift</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.35</span><span class="p">),</span>
            <span class="n">clip</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">],</span>
    <span class="n">num_data_fetchers</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="n">snapshot_interval</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
    <span class="n">min_masked</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span>
    <span class="n">min_labelled</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Create Run Config</span>

<span class="n">run_config</span> <span class="o">=</span> <span class="n">RunConfig</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;tutorial_run&quot;</span><span class="p">,</span>
    <span class="n">task_config</span><span class="o">=</span><span class="n">task_config</span><span class="p">,</span>
    <span class="n">architecture_config</span><span class="o">=</span><span class="n">architecture_config</span><span class="p">,</span>
    <span class="n">trainer_config</span><span class="o">=</span><span class="n">trainer_config</span><span class="p">,</span>
    <span class="n">datasplit_config</span><span class="o">=</span><span class="n">datasplit_config</span><span class="p">,</span>
    <span class="n">repetition</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">num_iterations</span><span class="o">=</span><span class="mi">100000</span><span class="p">,</span>
    <span class="n">validation_interval</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">run</span> <span class="o">=</span> <span class="n">Run</span><span class="p">(</span><span class="n">run_config</span><span class="p">)</span>

<span class="c1"># Store configs</span>

<span class="n">config_store</span> <span class="o">=</span> <span class="n">create_config_store</span><span class="p">()</span>

<span class="n">config_store</span><span class="o">.</span><span class="n">store_datasplit_config</span><span class="p">(</span><span class="n">datasplit_config</span><span class="p">)</span>
<span class="n">config_store</span><span class="o">.</span><span class="n">store_architecture_config</span><span class="p">(</span><span class="n">architecture_config</span><span class="p">)</span>
<span class="n">config_store</span><span class="o">.</span><span class="n">store_task_config</span><span class="p">(</span><span class="n">task_config</span><span class="p">)</span>
<span class="n">config_store</span><span class="o">.</span><span class="n">store_trainer_config</span><span class="p">(</span><span class="n">trainer_config</span><span class="p">)</span>
<span class="n">config_store</span><span class="o">.</span><span class="n">store_run_config</span><span class="p">(</span><span class="n">run_config</span><span class="p">)</span>

<span class="c1"># Optional start training by config name:</span>
<span class="n">train</span><span class="p">(</span><span class="n">run_config</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="install.html" class="btn btn-neutral float-left" title="Installation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="docker.html" class="btn btn-neutral float-right" title="Docker Configuration for JupyterHub-Dacapo" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Caroline Malin-Mayor, Jeff Rhoades, Marwan Zouinkhi, William Patton, David Ackerman, Jan Funke.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>