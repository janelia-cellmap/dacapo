dacapo.experiments.trainers.gp_augments.elastic_config
======================================================

.. py:module:: dacapo.experiments.trainers.gp_augments.elastic_config


Classes
-------

.. autoapisummary::

   dacapo.experiments.trainers.gp_augments.elastic_config.AugmentConfig
   dacapo.experiments.trainers.gp_augments.elastic_config.ElasticAugment
   dacapo.experiments.trainers.gp_augments.elastic_config.ElasticAugmentConfig


Module Contents
---------------

.. py:class:: AugmentConfig



   Base class for gunpowder augment configurations. Each subclass of a `Augment`
   should have a corresponding config class derived from `AugmentConfig`.

   .. attribute:: _raw_key

      Key for raw data. Not used in this implementation. Defaults to None.

   .. attribute:: _gt_key

      Key for ground truth data. Not used in this implementation. Defaults to None.

   .. attribute:: _mask_key

      Key for mask data. Not used in this implementation. Defaults to None.

   .. method:: node(_raw_key=None, _gt_key=None, _mask_key=None)

      Get a gp.Augment node.
      
      


   .. py:method:: node(raw_key: gunpowder.ArrayKey, gt_key: gunpowder.ArrayKey, mask_key: gunpowder.ArrayKey) -> gunpowder.BatchFilter
      :abstractmethod:


      Get a gunpowder augment node.

      :param raw_key: Key for raw data.
      :type raw_key: gp.ArrayKey
      :param gt_key: Key for ground truth data.
      :type gt_key: gp.ArrayKey
      :param mask_key: Key for mask data.
      :type mask_key: gp.ArrayKey

      :returns: Augmentation node which can be incorporated in the pipeline.
      :rtype: gunpowder.BatchFilter

      :raises NotImplementedError: This method is not implemented.

      .. rubric:: Examples

      >>> node = augment_config.node(raw_key, gt_key, mask_key)



.. py:class:: ElasticAugment(control_point_spacing, control_point_displacement_sigma, rotation_interval, subsample=1, augmentation_probability=1.0, seed=None, uniform_3d_rotation=False)



   Elasticly deform a batch. Requests larger batches upstream to avoid data
   loss due to rotation and jitter.
   :param control_point_spacing: Distance between control points for the elastic deformation, in voxels per dimension.
   :type control_point_spacing: tuple of int
   :param control_point_displacement_sigma: Standard deviation of control point displacement distribution, in world coordinates.
   :type control_point_displacement_sigma: tuple of float
   :param rotation_interval: Interval to randomly sample rotation angles from (0, 2PI).
   :type rotation_interval: tuple of two float
   :param subsample: Instead of creating an elastic transformation on the full resolution, create one sub-sampled by the given factor, and linearly interpolate to obtain the full resolution transformation. This can significantly speed up this node, at the expense of having visible piecewise linear deformations for large factors. Usually, a factor of 4 can safely be used without noticeable changes. However, the default is 1 (i.e., no sub-sampling).
   :type subsample: int
   :param seed: Set random state for reproducible results (tests only, do not use in production code!!)
   :type seed: int
   :param augmentation_probability: Probability to apply the augmentation.
   :type augmentation_probability: float
   :param uniform_3d_rotation: Use a uniform 3D rotation instead of a rotation around a random axis.
   :type uniform_3d_rotation: bool

   Provides:
       * The arrays in the batch, deformed.
   Requests:
       * The arrays in the batch, enlarged such that the deformed ROI fits into
         the enlarged input ROI.
   Method:
       setup: Set up the ElasticAugment node.
       prepare: Prepare the ElasticAugment node.
       process: Process the ElasticAugment node.
   .. rubric:: Notes

   This node is a port of the ElasticAugment node from the original
   `gunpowder <


   .. py:method:: setup()

      Set up the object by calculating the voxel size and spatial dimensions.

      This method calculates the voxel size by finding the minimum value for each axis
      from the voxel sizes of all array specs. It then sets the `voxel_size` attribute
      of the object. The spatial dimensions are also set based on the dimensions of the
      voxel size.

      :raises AssertionError: If the voxel size is not a Coordinate object.

      .. rubric:: Examples

      >>> setup()



   .. py:method:: prepare(request)

      Prepares the request for augmentation.

      :param request: The request object containing the data to be augmented.

      :raises AssertionError: If the key in the request is not an ArrayKey or GraphKey.

      .. rubric:: Examples

      >>> prepare(request)

      .. rubric:: Notes

      This method prepares the request for augmentation by performing the following steps:
      1. Logs the preparation details, including the transformation voxel size.
      2. Calculates the master ROI based on the total ROI.
      3. Generates a uniform random sample and determines whether to perform augmentation based on the augmentation probability.
      4. If augmentation is not required, logs the decision and returns.
      5. Snaps the master ROI to the grid based on the voxel size and calculates the master transformation.
      6. Clears the existing transformations and target ROIs.
      7. Iterates over each key in the request and prepares it for augmentation.
      8. Updates the upstream request with the modified ROI.



   .. py:method:: process(batch, request)

      Process the ElasticAugment node.

      :param batch: The batch object containing the data to be processed.
      :param request: The request object specifying the data to be processed.

      :raises AssertionError: If the key in the request is not an ArrayKey or GraphKey.

      .. rubric:: Examples

      >>> process(batch, request)

      .. rubric:: Notes

      This method applies the transformation to the data in the batch and restores the original ROIs.



.. py:class:: ElasticAugmentConfig



   A class that holds the configuration details for the elastic augmentations.

   .. attribute:: control_point_spacing

      Distance(in voxels per dimension) between control points for
      the elastic deformation.

      :type: List[int]

   .. attribute:: control_point_displacement_sigma

      Standard deviation of control point displacement
      distribution, in world coordinates.

      :type: List[float]

   .. attribute:: rotation_interval

      An interval to randomly sample rotation angles from
      (0,2PI).

      :type: Tuple[float, float]

   .. attribute:: subsample

      Downsample factor to perform the elastic augmentation
      on a grid. Default is 1.

      :type: int

   .. attribute:: uniform_3d_rotation

      Should 3D rotations be performed uniformly. The 'rotation_interval'
      will be ignored. Default is False.

      :type: bool

   .. method:: node(_raw_key=None, _gt_key=None, _mask_key=None)

      Returns the object of ElasticAugment with the given
      configuration details.
      
      


   .. py:attribute:: control_point_spacing
      :type:  List[int]


   .. py:attribute:: control_point_displacement_sigma
      :type:  List[float]


   .. py:attribute:: rotation_interval
      :type:  Tuple[float, float]


   .. py:attribute:: subsample
      :type:  int


   .. py:attribute:: uniform_3d_rotation
      :type:  bool


   .. py:method:: node(_raw_key=None, _gt_key=None, _mask_key=None)

      Returns the object of ElasticAugment with the given configuration details.

      :param _raw_key: Unused variable, kept for future use.
      :param _gt_key: Unused variable, kept for future use.
      :param _mask_key: Unused variable, kept for future use.

      :returns:

                A ElasticAugment object configured with `control_point_spacing`,
                                `control_point_displacement_sigma`, `rotation_interval`, `subsample` and
                                `uniform_3d_rotation`.
      :rtype: ElasticAugment

      :raises NotImplementedError: This method is not implemented.

      .. rubric:: Examples

      >>> node = elastic_augment_config.node()



